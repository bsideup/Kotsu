box: wercker/nodejs
build:
  steps:
    - script:
        name: echo nodejs information
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"
    - npm-install
    - script:
        name: install grunt-cli
        code: sudo npm install -g grunt-cli
    - script:
        name: install sass
        code: sudo gem install sass --no-ri --no-rdoc
    - npm-test
    - script:
        name: update docker
        code: curl -sSL https://get.docker.io/ubuntu/ | sudo sh
    - script:
        name: build image
        code: sudo docker build -t $DOCKER_IMAGE_NAME:$WERCKER_GIT_COMMIT .
    - script:
        name: login to docker hub
        code: sudo docker login -u $DOCKER_USER -p $DOCKER_PASSWORD -e $DOCKER_EMAIL
    - script:
        name: push image
        code: sudo docker push $DOCKER_IMAGE_NAME:$WERCKER_GIT_COMMIT
  after-steps:
    - sherzberg/slack-notify:
        subdomain: 2bad
        token: $SLACK_TOKEN
        channel: general
        username: wercker
        icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140
deploy:
  steps:
    - add-ssh-key:
        keyname: SERVER_KEY
    - add-to-known_hosts:
        hostname: $DEPLOY_SERVER
    - mktemp:
        name: temp service file
        envvar: SERVICE_PATH
    - create-file:
        name: service file
        filename: $SERVICE_PATH
        overwrite: true
        content: |
          [Unit]
          Description=Nginx based application
          After=docker.service
          Requires=docker.service
          [Service]
          Restart=always
          User=core
          TimeoutStartSec=0
          EnvironmentFile=-/etc/app.conf
          ExecStartPre=-/usr/bin/docker kill app
          ExecStartPre=-/usr/bin/docker rm app
          ExecStartPre=/usr/bin/docker pull $DOCKER_IMAGE_NAME:$WERCKER_GIT_COMMIT
          ExecStart=/usr/bin/docker run --name app -p 80:80 --restart="always" $DOCKER_IMAGE_NAME:$WERCKER_GIT_COMMIT
          [Install]
          WantedBy=multi-user.target
    - script:
        name: copy service file
        code: scp $SERVICE_PATH core@$DEPLOY_SERVER:/home/core/app.service
    - script:
        name: login to docker hub
        code: ssh core@$DEPLOY_SERVER docker login -u $DOCKER_USER -p $DOCKER_PASSWORD -e $DOCKER_EMAIL
    - script:
        name: link service file
        code: ssh core@$DEPLOY_SERVER sudo mv /home/core/app.service /etc/systemd/system/app.service
    - script:
        name: chmod service file
        code: ssh core@$DEPLOY_SERVER sudo chmod +x /etc/systemd/system/app.service
    - script:
        name: reload systemd
        code: ssh core@$DEPLOY_SERVER sudo systemctl daemon-reload
    - script:
        name: enable service
        code: ssh core@$DEPLOY_SERVER sudo systemctl enable app.service
    - script:
        name: restart service
        code: ssh core@$DEPLOY_SERVER sudo systemctl restart app.service